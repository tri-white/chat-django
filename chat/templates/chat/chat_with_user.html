{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4">
    <h2 class="text-center">Чат з {{ other_user.username }}</h2>

    {% if last_activity %}
      <p class="text-center">Остання активність: {{ last_activity|timesince }} тому</p>
    {% endif %}

    <div id="chat-messages" class="col-8 mx-auto px-auto" style="max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column-reverse;">
      {% for message in messages %}
        <div class="mb-3 col-5 {% if message.sender == current_user %}text-end{% endif %}" style="{% if message.sender == current_user %}align-self: flex-end;{% else %}align-self: flex-start;{% endif %}">
          <div class="card col-12 mx-auto" style="background-color: {% if message.sender == current_user %}yellow{% else %}lightgreen{% endif %};">
            <div class="card-body">
              {% if message.sender == current_user %}
                {% if message.content != "deleted message" %}
                  <a href="{% url 'edit_message' message.id %}" class="btn btn-sm btn-outline-primary me-1">Редагувати</a>
                  <a href="{% url 'delete_message' message.id %}" class="btn btn-sm btn-outline-danger">Видалити</a>
                  <p class="card-text">{{ message.content }}</p>
                {% else %}
                  <p class="card-text" style="color: gray;">
                    <span style="font-size: 80%;">&times;</span>видалене повідомлення<span style="font-size: 80%;">&times;</span>
                  </p>
                {% endif %}
              {% else %}
                <p class="card-text">{{ message.content }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
      
    </div>

    <form method="post" action="{% url 'send_message' other_user.id %}" id="message-form" class="mt-3 col-8 mx-auto px-auto">
      {% csrf_token %}
      <div class="input-group">
        <input type="text" name="content" class="form-control" required>
        <button type="submit" class="btn btn-dark">Надіслати</button>
      </div>
    </form>
  </div>

  <script>
    // Scroll to the bottom of the chat messages box
    var chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
  </script>
{% endblock %}
